<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      MacPollo Analytics - Sistema de An√°lisis de Costos de Limpieza
    </title>

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Favicon -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêî</text></svg>"
    />

    <style>
      /* Variables CSS Profesionales */
      :root {
        /* Paleta de colores MacPollo */
        --primary-50: #fff7ed;
        --primary-100: #ffedd5;
        --primary-200: #fed7aa;
        --primary-300: #fdba74;
        --primary-400: #fb923c;
        --primary-500: #f97316;
        --primary-600: #ea580c;
        --primary-700: #c2410c;
        --primary-800: #9a3412;
        --primary-900: #7c2d12;

        --accent-50: #fef3c7;
        --accent-100: #fef3c7;
        --accent-200: #fde68a;
        --accent-300: #fcd34d;
        --accent-400: #fbbf24;
        --accent-500: #f59e0b;
        --accent-600: #d97706;
        --accent-700: #b45309;
        --accent-800: #92400e;
        --accent-900: #78350f;

        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;

        --success-50: #ecfdf5;
        --success-500: #10b981;
        --success-600: #059669;

        --warning-50: #fffbeb;
        --warning-500: #f59e0b;
        --warning-600: #d97706;

        --error-50: #fef2f2;
        --error-500: #ef4444;
        --error-600: #dc2626;

        /* Variables din√°micas */
        --background: var(--gray-50);
        --surface: #ffffff;
        --surface-secondary: var(--gray-100);
        --text-primary: var(--gray-900);
        --text-secondary: var(--gray-600);
        --text-tertiary: var(--gray-500);
        --border: var(--gray-200);
        --border-focus: var(--primary-500);
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1),
          0 4px 6px -4px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1),
          0 8px 10px -6px rgb(0 0 0 / 0.1);

        /* Tipograf√≠a */
        --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Roboto", sans-serif;
        --font-mono: "JetBrains Mono", "Fira Code", "Consolas", monospace;

        /* Espaciado */
        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 0.75rem;
        --space-4: 1rem;
        --space-5: 1.25rem;
        --space-6: 1.5rem;
        --space-8: 2rem;
        --space-10: 2.5rem;
        --space-12: 3rem;
        --space-16: 4rem;
        --space-20: 5rem;

        /* Border radius */
        --radius-sm: 0.375rem;
        --radius: 0.5rem;
        --radius-md: 0.75rem;
        --radius-lg: 1rem;
        --radius-xl: 1.5rem;
        --radius-2xl: 2rem;

        /* Transiciones */
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Tema oscuro */
      [data-theme="dark"] {
        --background: var(--gray-900);
        --surface: var(--gray-800);
        --surface-secondary: var(--gray-700);
        --text-primary: var(--gray-100);
        --text-secondary: var(--gray-300);
        --text-tertiary: var(--gray-400);
        --border: var(--gray-600);
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
        --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3), 0 1px 2px -1px rgb(0 0 0 / 0.3);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3),
          0 2px 4px -2px rgb(0 0 0 / 0.3);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3),
          0 4px 6px -4px rgb(0 0 0 / 0.3);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.3),
          0 8px 10px -6px rgb(0 0 0 / 0.3);
      }

      /* Reset CSS profesional */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html {
        line-height: 1.5;
        -webkit-text-size-adjust: 100%;
        font-family: var(--font-sans);
      }

      body {
        margin: 0;
        font-family: var(--font-sans);
        background-color: var(--background);
        color: var(--text-primary);
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        transition: background-color var(--transition), color var(--transition);
      }

      /* Scrollbar personalizada */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--surface-secondary);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--gray-400);
        border-radius: var(--radius);
        transition: background-color var(--transition);
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--gray-500);
      }

      /* Layout principal */
      .app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .app-header {
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        padding: var(--space-4) var(--space-6);
        position: sticky;
        top: 0;
        z-index: 50;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95);
        transition: all var(--transition);
      }

      [data-theme="dark"] .app-header {
        background: rgba(31, 41, 55, 0.95);
      }

      .header-content {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: var(--space-4);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        text-decoration: none;
        color: var(--text-primary);
      }

      .brand-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(
          135deg,
          var(--primary-500),
          var(--primary-600)
        );
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
      }

      .brand-text {
        display: flex;
        flex-direction: column;
      }

      .brand-name {
        font-size: 1.25rem;
        font-weight: 700;
        line-height: 1.2;
        background: linear-gradient(
          135deg,
          var(--primary-600),
          var(--accent-600)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .brand-tagline {
        font-size: 0.75rem;
        color: var(--text-secondary);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: var(--space-3);
      }

      .theme-toggle {
        width: 44px;
        height: 44px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all var(--transition);
        font-size: 1.25rem;
      }

      .theme-toggle:hover {
        background: var(--surface-secondary);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      /* Layout principal */
      .main-container {
        flex: 1;
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--space-8) var(--space-6);
        width: 100%;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: 420px 1fr;
        gap: var(--space-8);
        height: calc(100vh - 120px);
        min-height: 800px;
      }

      /* Paneles */
      .panel {
        background: var(--surface);
        border-radius: var(--radius-xl);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: box-shadow var(--transition);
      }

      .panel:hover {
        box-shadow: var(--shadow-lg);
      }

      .panel-header {
        padding: var(--space-6);
        border-bottom: 1px solid var(--border);
        background: linear-gradient(
          135deg,
          var(--primary-50),
          var(--accent-50)
        );
      }

      [data-theme="dark"] .panel-header {
        background: linear-gradient(135deg, var(--gray-800), var(--gray-700));
      }

      .panel-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--space-2);
      }

      .panel-subtitle {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: var(--space-1);
      }

      .panel-content {
        flex: 1;
        padding: var(--space-6);
        overflow-y: auto;
      }

      /* Formulario */
      .form-section {
        margin-bottom: var(--space-8);
      }

      .form-section:last-child {
        margin-bottom: 0;
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-bottom: var(--space-4);
        padding-bottom: var(--space-2);
        border-bottom: 1px solid var(--border);
      }

      .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .section-icon {
        font-size: 1.25rem;
      }

      .form-grid {
        display: grid;
        gap: var(--space-4);
      }

      .form-grid.cols-2 {
        grid-template-columns: 1fr 1fr;
      }

      .form-field {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
      }

      .form-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-primary);
      }

      .form-input,
      .form-textarea {
        width: 100%;
        padding: var(--space-3) var(--space-4);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        background: var(--surface);
        color: var(--text-primary);
        font-size: 0.875rem;
        font-family: var(--font-sans);
        transition: all var(--transition);
        position: relative;
      }

      .form-input:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--border-focus);
        box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
      }

      .form-input.error {
        border-color: var(--error-500);
        box-shadow: 0 0 0 3px var(--error-50);
      }

      .form-input:disabled {
        background: var(--surface-secondary);
        cursor: not-allowed;
        opacity: 0.6;
      }

      .input-wrapper {
        position: relative;
      }

      .input-unit {
        position: absolute;
        right: var(--space-3);
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.75rem;
        color: var(--text-tertiary);
        font-weight: 500;
        pointer-events: none;
      }

      .form-textarea {
        resize: vertical;
        min-height: 80px;
      }

      .form-error {
        font-size: 0.75rem;
        color: var(--error-500);
        margin-top: var(--space-1);
      }

      .form-help {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        margin-top: var(--space-1);
      }

      /* Botones */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        padding: var(--space-3) var(--space-6);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all var(--transition);
        font-family: var(--font-sans);
        min-height: 44px;
        position: relative;
        overflow: hidden;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-500),
          var(--primary-600)
        );
        color: white;
        box-shadow: var(--shadow);
      }

      .btn-primary:hover:not(:disabled) {
        background: linear-gradient(
          135deg,
          var(--primary-600),
          var(--primary-700)
        );
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      .btn-secondary {
        background: var(--surface);
        color: var(--text-primary);
        border: 1px solid var(--border);
      }

      .btn-secondary:hover:not(:disabled) {
        background: var(--surface-secondary);
        transform: translateY(-1px);
      }

      .btn-lg {
        padding: var(--space-4) var(--space-8);
        font-size: 1rem;
        min-height: 52px;
      }

      .btn-sm {
        padding: var(--space-2) var(--space-3);
        font-size: 0.75rem;
        min-height: 36px;
      }

      .btn-full {
        width: 100%;
      }

      .btn-loading {
        color: transparent;
      }

      .btn-loading::after {
        content: "";
        position: absolute;
        width: 20px;
        height: 20px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        color: white;
      }

      .form-actions {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
        margin-top: var(--space-8);
      }

      /* Panel de resultados */
      .results-panel {
        position: relative;
      }

      .results-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 400px;
        text-align: center;
        color: var(--text-tertiary);
      }

      .results-empty-icon {
        font-size: 4rem;
        margin-bottom: var(--space-4);
        opacity: 0.5;
      }

      .results-empty-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: var(--space-2);
      }

      .results-empty-text {
        font-size: 0.875rem;
      }

      .results-tabs {
        display: flex;
        background: var(--surface-secondary);
        border-radius: var(--radius-md);
        padding: var(--space-1);
        margin-bottom: var(--space-6);
      }

      .tab-button {
        flex: 1;
        padding: var(--space-2) var(--space-4);
        background: transparent;
        border: none;
        border-radius: var(--radius);
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all var(--transition);
        font-family: var(--font-sans);
      }

      .tab-button.active {
        background: var(--surface);
        color: var(--primary-600);
        box-shadow: var(--shadow-sm);
        transform: translateY(-1px);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      /* M√©tricas */
      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-6);
      }

      .metric-card {
        background: var(--surface-secondary);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        border: 1px solid var(--border);
        transition: all var(--transition);
        position: relative;
        overflow: hidden;
      }

      .metric-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          var(--primary-500),
          var(--primary-600)
        );
      }

      .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .metric-header {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-bottom: var(--space-3);
      }

      .metric-icon {
        font-size: 1.5rem;
      }

      .metric-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-600);
        margin-bottom: var(--space-2);
        font-family: var(--font-mono);
      }

      .metric-description {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        line-height: 1.4;
      }

      .metric-badge {
        display: inline-flex;
        align-items: center;
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        margin-top: var(--space-2);
      }

      .badge-excellent {
        background: var(--success-50);
        color: var(--success-600);
      }

      .badge-good {
        background: var(--primary-50);
        color: var(--primary-600);
      }

      .badge-regular {
        background: var(--warning-50);
        color: var(--warning-600);
      }

      .badge-poor {
        background: var(--error-50);
        color: var(--error-600);
      }

      /* Gr√°ficos */
      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: var(--space-6);
        margin-bottom: var(--space-6);
      }

      .chart-container {
        background: var(--surface-secondary);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        border: 1px solid var(--border);
      }

      .chart-header {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-bottom: var(--space-6);
      }

      .chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .chart-wrapper {
        position: relative;
        height: 300px;
      }

      /* An√°lisis */
      .analysis-section {
        background: var(--surface-secondary);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        margin-bottom: var(--space-6);
        border: 1px solid var(--border);
      }

      .analysis-header {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-bottom: var(--space-4);
      }

      .analysis-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .benchmark-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
      }

      .benchmark-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-3);
        background: var(--surface);
        border-radius: var(--radius);
        border: 1px solid var(--border);
      }

      .benchmark-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .benchmark-value {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
        font-family: var(--font-mono);
      }

      .benchmark-highlight {
        border-color: var(--primary-200);
        background: var(--primary-50);
      }

      /* Estilos para historial */
      .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-4);
        background: var(--surface);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        margin-bottom: var(--space-3);
        transition: all var(--transition);
      }

      .history-item:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
        border-color: var(--primary-200);
      }

      .history-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
      }

      .history-date {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: 0.875rem;
        color: var(--text-primary);
      }

      .history-icon {
        font-size: 1rem;
      }

      .history-summary {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: 0.75rem;
        color: var(--text-secondary);
        font-family: var(--font-mono);
      }

      .history-actions {
        display: flex;
        gap: var(--space-2);
      }

      .history-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-4);
        padding: var(--space-3);
        background: var(--surface-secondary);
        border-radius: var(--radius);
        border: 1px solid var(--border);
      }

      .history-stats {
        display: flex;
        align-items: center;
        gap: var(--space-2);
      }

      .history-count {
        font-size: 0.875rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .history-list {
        max-height: 500px;
        overflow-y: auto;
      }

      /* Notificaciones */
      .notification {
        position: fixed;
        top: var(--space-6);
        right: var(--space-6);
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        box-shadow: var(--shadow-xl);
        z-index: 100;
        display: flex;
        align-items: center;
        gap: var(--space-3);
        max-width: 400px;
        animation: slideInRight 0.3s ease;
      }

      .notification.success {
        border-left: 4px solid var(--success-500);
      }

      .notification.error {
        border-left: 4px solid var(--error-500);
      }

      .notification-icon {
        font-size: 1.25rem;
      }

      .notification-content {
        flex: 1;
      }

      .notification-title {
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: var(--space-1);
      }

      .notification-message {
        font-size: 0.75rem;
        color: var(--text-secondary);
      }

      /* Animaciones */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes slideOutRight {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(100%);
        }
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .fade-in {
        animation: fadeIn 0.6s ease;
      }

      /* Responsive Design */
      @media (max-width: 1200px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
          height: auto;
          min-height: auto;
        }

        .charts-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .main-container {
          padding: var(--space-4);
        }

        .dashboard-grid {
          gap: var(--space-4);
        }

        .panel-content {
          padding: var(--space-4);
        }

        .form-grid.cols-2 {
          grid-template-columns: 1fr;
        }

        .metrics-grid {
          grid-template-columns: 1fr;
        }

        .header-content {
          padding: var(--space-3);
        }

        .brand-text {
          display: none;
        }

        .notification {
          top: var(--space-4);
          right: var(--space-4);
          left: var(--space-4);
          max-width: none;
        }

        .history-item {
          flex-direction: column;
          align-items: flex-start;
          gap: var(--space-3);
        }

        .history-actions {
          width: 100%;
          justify-content: flex-end;
        }

        .history-controls {
          flex-direction: column;
          gap: var(--space-3);
          align-items: flex-start;
        }
      }

      @media (max-width: 480px) {
        .main-container {
          padding: var(--space-2);
        }

        .panel-content {
          padding: var(--space-3);
        }

        .panel-header {
          padding: var(--space-4);
        }
      }

      /* Estados de carga */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: var(--radius-xl);
      }

      [data-theme="dark"] .loading-overlay {
        background: rgba(31, 41, 55, 0.8);
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--gray-200);
        border-top: 4px solid var(--primary-500);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      /* Validaci√≥n visual */
      .form-field.error .form-label {
        color: var(--error-500);
      }

      .form-field.success .form-input {
        border-color: var(--success-500);
      }

      .form-field.success .form-label {
        color: var(--success-600);
      }

      /* Accesibilidad */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      /* Focus visible */
      .btn:focus-visible,
      .theme-toggle:focus-visible,
      .tab-button:focus-visible {
        outline: 2px solid var(--primary-500);
        outline-offset: 2px;
      }
    </style>
  </head>
  <body data-theme="light">
    <div class="app">
      <!-- Header -->
      <header class="app-header">
        <div class="header-content">
          <a href="#" class="brand">
            <div class="brand-icon">üêî</div>
            <div class="brand-text">
              <div class="brand-name">MacPollo Analytics</div>
              <div class="brand-tagline">Sistema de An√°lisis Industrial</div>
            </div>
          </a>

          <div class="header-actions">
            <button
              class="theme-toggle"
              id="themeToggle"
              aria-label="Cambiar tema"
            >
              <span id="themeIcon">üåô</span>
            </button>
          </div>
        </div>
      </header>

      <!-- Contenido principal -->
      <main class="main-container">
        <div class="dashboard-grid">
          <!-- Panel de entrada de datos -->
          <div class="panel fade-in">
            <div class="panel-header">
              <h2 class="panel-title">
                <span>üìä</span>
                Datos del Proceso
              </h2>
              <p class="panel-subtitle">
                Ingresa la informaci√≥n de tu proceso de limpieza
              </p>
            </div>

            <div class="panel-content">
              <form id="processForm" novalidate>
                <!-- Datos de producci√≥n -->
                <div class="form-section">
                  <div class="section-header">
                    <span class="section-icon">üêî</span>
                    <h3 class="section-title">Datos de Producci√≥n</h3>
                  </div>

                  <div class="form-grid">
                    <div class="form-field" id="field-kilosPollo">
                      <label class="form-label" for="kilosPollo"
                        >Kilos de Pollo Procesados *</label
                      >
                      <div class="input-wrapper">
                        <input
                          type="number"
                          id="kilosPollo"
                          name="kilosPollo"
                          class="form-input"
                          placeholder="1000.00"
                          step="0.01"
                          min="0.01"
                          required
                          autocomplete="off"
                        />
                        <span class="input-unit">kg</span>
                      </div>
                      <div class="form-help">
                        Cantidad total de pollo procesado en el lote
                      </div>
                      <div class="form-error" id="error-kilosPollo"></div>
                    </div>
                  </div>
                </div>

                <!-- Consumo de agua -->
                <div class="form-section">
                  <div class="section-header">
                    <span class="section-icon">üíß</span>
                    <h3 class="section-title">Consumo de Agua</h3>
                  </div>

                  <div class="form-grid cols-2">
                    <div class="form-field" id="field-aguaConsumida">
                      <label class="form-label" for="aguaConsumida"
                        >Metros C√∫bicos Consumidos *</label
                      >
                      <div class="input-wrapper">
                        <input
                          type="number"
                          id="aguaConsumida"
                          name="aguaConsumida"
                          class="form-input"
                          placeholder="15.50"
                          step="0.01"
                          min="0"
                          required
                          autocomplete="off"
                        />
                        <span class="input-unit">m¬≥</span>
                      </div>
                      <div class="form-error" id="error-aguaConsumida"></div>
                    </div>

                    <div class="form-field" id="field-costoAgua">
                      <label class="form-label" for="costoAgua"
                        >Costo por m¬≥ *</label
                      >
                      <div class="input-wrapper">
                        <input
                          type="number"
                          id="costoAgua"
                          name="costoAgua"
                          class="form-input"
                          placeholder="4500"
                          step="1"
                          min="0"
                          required
                          autocomplete="off"
                        />
                        <span class="input-unit">COP</span>
                      </div>
                      <div class="form-error" id="error-costoAgua"></div>
                    </div>
                  </div>
                </div>

                <!-- Insumos qu√≠micos -->
                <div class="form-section">
                  <div class="section-header">
                    <span class="section-icon">üß™</span>
                    <h3 class="section-title">Insumos Qu√≠micos</h3>
                  </div>

                  <div class="form-grid">
                    <div class="form-field" id="field-costoInsumos">
                      <label class="form-label" for="costoInsumos"
                        >Costo Total de Insumos *</label
                      >
                      <div class="input-wrapper">
                        <input
                          type="number"
                          id="costoInsumos"
                          name="costoInsumos"
                          class="form-input"
                          placeholder="250000"
                          step="1"
                          min="0"
                          required
                          autocomplete="off"
                        />
                        <span class="input-unit">COP</span>
                      </div>
                      <div class="form-help">
                        Costo total de todos los productos qu√≠micos utilizados
                      </div>
                      <div class="form-error" id="error-costoInsumos"></div>
                    </div>

                    <div class="form-field">
                      <label class="form-label" for="detalleInsumos"
                        >Detalle de Insumos (Opcional)</label
                      >
                      <textarea
                        id="detalleInsumos"
                        name="detalleInsumos"
                        class="form-textarea"
                        placeholder="Ej: Desinfectante industrial, detergente biodegradable, cloro l√≠quido, sanitizante..."
                        rows="3"
                      ></textarea>
                      <div class="form-help">
                        Describe los insumos utilizados para referencia
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Acciones -->
                <div class="form-actions">
                  <button
                    type="submit"
                    class="btn btn-primary btn-lg btn-full"
                    id="calculateBtn"
                  >
                    <span>üßÆ</span>
                    Calcular An√°lisis
                  </button>

                  <button
                    type="button"
                    class="btn btn-secondary btn-full"
                    id="resetBtn"
                  >
                    <span>üîÑ</span>
                    Limpiar Formulario
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Panel de resultados -->
          <div class="panel fade-in results-panel" id="resultsPanel">
            <div class="panel-header">
              <h2 class="panel-title">
                <span>üìà</span>
                An√°lisis y Estad√≠sticas
              </h2>
              <p class="panel-subtitle">
                Resultados del an√°lisis de costos y eficiencia
              </p>
            </div>

            <div class="panel-content" id="resultsContent">
              <div class="results-empty">
                <div class="results-empty-icon">üìä</div>
                <div class="results-empty-title">Sin datos que mostrar</div>
                <div class="results-empty-text">
                  Ingresa los datos del proceso para ver el an√°lisis completo
                  con m√©tricas, gr√°ficos y recomendaciones espec√≠ficas para
                  MacPollo
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Chart.js desde CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- jsPDF para generar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
      // Estado de la aplicaci√≥n
      const AppState = {
        currentResults: null,
        charts: {
          pie: null,
          bar: null,
          efficiency: null,
        },
        theme: localStorage.getItem("theme") || "light",
        formData: {},
      };

      // Configuraci√≥n de la aplicaci√≥n para MacPollo
      const AppConfig = {
        benchmarks: {
          costoPorKiloOptimo: 300, // COP
          costoPorKiloPromedio: 500, // COP
          aguaPorKiloOptimo: 20, // litros
          aguaPorKiloPromedio: 30, // litros
        },
        validation: {
          kilosPollo: { min: 0.01, max: 100000 },
          aguaConsumida: { min: 0, max: 10000 },
          costoAgua: { min: 0, max: 50000 }, // COP
          costoInsumos: { min: 0, max: 10000000 }, // COP
        },
      };

      // Utilidad para formatear moneda colombiana
      function formatCOP(amount) {
        return new Intl.NumberFormat("es-CO", {
          style: "currency",
          currency: "COP",
          minimumFractionDigits: 0,
          maximumFractionDigits: 2,
        }).format(amount);
      }

      // Inicializaci√≥n de la aplicaci√≥n
      class MacPolloAnalytics {
        constructor() {
          this.init();
        }

        init() {
          this.setupTheme();
          this.setupForm();
          this.setupEventListeners();
          this.setupAnimations();

          // Hacer la instancia accesible globalmente
          window.app = this;
        }

        setupTheme() {
          document.documentElement.setAttribute("data-theme", AppState.theme);
          this.updateThemeIcon();

          document
            .getElementById("themeToggle")
            .addEventListener("click", () => {
              AppState.theme = AppState.theme === "light" ? "dark" : "light";
              document.documentElement.setAttribute(
                "data-theme",
                AppState.theme
              );
              localStorage.setItem("theme", AppState.theme);
              this.updateThemeIcon();

              // Actualizar gr√°ficos si existen
              if (AppState.currentResults) {
                setTimeout(
                  () => this.createCharts(AppState.currentResults),
                  100
                );
              }
            });
        }

        updateThemeIcon() {
          const icon = document.getElementById("themeIcon");
          icon.textContent = AppState.theme === "light" ? "üåô" : "‚òÄÔ∏è";
        }

        setupForm() {
          const form = document.getElementById("processForm");
          form.addEventListener("submit", (e) => this.handleSubmit(e));

          // Validaci√≥n en tiempo real
          const inputs = form.querySelectorAll("input[required]");
          inputs.forEach((input) => {
            input.addEventListener("blur", () => this.validateField(input));
            input.addEventListener("input", () => this.clearFieldError(input));
          });

          // Reset form
          document
            .getElementById("resetBtn")
            .addEventListener("click", () => this.resetForm());
        }

        setupEventListeners() {
          // Manejo de errores globales
          window.addEventListener("error", (e) => {
            console.error("Error de aplicaci√≥n:", e.error);
            this.showNotification(
              "error",
              "Error del Sistema",
              "Se produjo un error inesperado. Por favor, recarga la p√°gina."
            );
          });

          // Responsive charts
          window.addEventListener("resize", () => {
            if (AppState.currentResults) {
              this.debounce(
                () => this.createCharts(AppState.currentResults),
                300
              )();
            }
          });
        }

        setupAnimations() {
          const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("fade-in");
              }
            });
          });

          document
            .querySelectorAll(".panel, .metric-card, .chart-container")
            .forEach((el) => {
              observer.observe(el);
            });
        }

        // ===== M√âTODOS DE HISTORIAL =====

        // M√©todo para guardar an√°lisis en el historial
        saveToHistory(results) {
          try {
            const historyItem = {
              id: this.generateHistoryId(),
              timestamp: new Date().toISOString(),
              date: new Date().toLocaleDateString("es-CO", {
                year: "numeric",
                month: "long",
                day: "numeric",
              }),
              time: new Date().toLocaleTimeString("es-CO", {
                hour: "2-digit",
                minute: "2-digit",
              }),
              results: { ...results },
            };

            const history = this.getHistory();
            history.unshift(historyItem); // Agregar al inicio (m√°s reciente primero)

            // Limitar a 50 an√°lisis m√°ximo para no sobrecargar localStorage
            if (history.length > 50) {
              history.splice(50);
            }

            localStorage.setItem("macpollo_history", JSON.stringify(history));

            return historyItem.id;
          } catch (error) {
            console.error("Error guardando en historial:", error);
            this.showNotification(
              "error",
              "Error de Historial",
              "No se pudo guardar el an√°lisis en el historial"
            );
          }
        }

        // M√©todo para obtener el historial
        getHistory() {
          try {
            const historyData = localStorage.getItem("macpollo_history");
            return historyData ? JSON.parse(historyData) : [];
          } catch (error) {
            console.error("Error cargando historial:", error);
            return [];
          }
        }

        // M√©todo para generar ID √∫nico
        generateHistoryId() {
          return (
            "analysis_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 9)
          );
        }

        // M√©todo para cargar an√°lisis desde historial
        loadFromHistory(id) {
          try {
            const history = this.getHistory();
            const analysisItem = history.find((item) => item.id === id);

            if (!analysisItem) {
              this.showNotification(
                "error",
                "Error",
                "An√°lisis no encontrado en el historial"
              );
              return;
            }

            // Establecer como resultados actuales y mostrar
            AppState.currentResults = analysisItem.results;
            this.displayResults(analysisItem.results);

            // Cambiar a la pesta√±a de m√©tricas para ver los resultados
            const metricsTab = document.querySelector(
              '.tab-button[data-tab="metrics"]'
            );
            if (metricsTab) {
              metricsTab.click();
            }

            this.showNotification(
              "success",
              "An√°lisis Cargado",
              `An√°lisis del ${analysisItem.date} cargado exitosamente`
            );
          } catch (error) {
            console.error("Error cargando desde historial:", error);
            this.showNotification(
              "error",
              "Error de Carga",
              "No se pudo cargar el an√°lisis desde el historial"
            );
          }
        }

        // M√©todo para limpiar historial
        clearHistory() {
          try {
            localStorage.removeItem("macpollo_history");

            // Actualizar la vista del historial si est√° activa
            const historyTab = document.getElementById("tab-history");
            if (historyTab && historyTab.classList.contains("active")) {
              this.renderHistoryTab();
            }

            this.showNotification(
              "success",
              "Historial Limpiado",
              "Todo el historial ha sido eliminado"
            );
          } catch (error) {
            console.error("Error limpiando historial:", error);
            this.showNotification(
              "error",
              "Error",
              "No se pudo limpiar el historial"
            );
          }
        }

        // M√©todo para renderizar la pesta√±a de historial
        renderHistoryTab() {
          const history = this.getHistory();

          if (history.length === 0) {
            return `
        <div class="analysis-section">
          <div class="analysis-header">
            <span>üìä</span>
            <h3 class="analysis-title">Historial de An√°lisis</h3>
          </div>
          <div class="results-empty" style="height: 300px;">
            <div class="results-empty-icon">üïí</div>
            <div class="results-empty-title">Sin historial disponible</div>
            <div class="results-empty-text">Los an√°lisis procesados aparecer√°n aqu√≠ autom√°ticamente</div>
          </div>
        </div>
      `;
          }

          const historyItems = history
            .map(
              (item) => `
        <div class="benchmark-item history-item" data-id="${item.id}">
          <div class="history-info">
            <div class="history-date">
              <span class="history-icon">üìÖ</span>
              <strong>${item.date}</strong> a las ${item.time}
            </div>
            <div class="history-summary">
              <span>üìä ${formatCOP(item.results.costoTotal)} total</span>
              <span>‚Ä¢</span>
              <span>üêî ${item.results.kilosPollo.toLocaleString(
                "es-CO"
              )} kg</span>
              <span>‚Ä¢</span>
              <span>üíß ${item.results.aguaConsumida} m¬≥</span>
            </div>
          </div>
          <div class="history-actions">
            <button class="btn btn-secondary btn-sm" onclick="window.app.loadFromHistory('${
              item.id
            }')" title="Ver este an√°lisis">
              <span>üëÅÔ∏è</span>
              Ver
            </button>
            <button class="btn btn-primary btn-sm" onclick="window.app.generatePDFReport('${
              item.id
            }')" title="Descargar informe PDF">
              <span>üìÑ</span>
              PDF
            </button>
          </div>
        </div>
      `
            )
            .join("");

          return `
      <div class="analysis-section">
        <div class="analysis-header">
          <span>üìä</span>
          <h3 class="analysis-title">Historial de An√°lisis MacPollo</h3>
        </div>
        <div class="history-controls">
          <div class="history-stats">
            <span class="history-count">${history.length} an√°lisis guardados</span>
          </div>
          <button class="btn btn-secondary" onclick="window.app.clearHistoryWithConfirm()" title="Limpiar todo el historial">
            <span>üßπ</span>
            Limpiar Historial
          </button>
        </div>
        <div class="benchmark-list history-list">
          ${historyItems}
        </div>
      </div>
    `;
        }

        // M√©todo para confirmar limpieza de historial
        clearHistoryWithConfirm() {
          if (
            confirm(
              "¬øEst√°s seguro de que quieres eliminar todo el historial? Esta acci√≥n no se puede deshacer."
            )
          ) {
            this.clearHistory();
          }
        }

        // ===== M√âTODO PREMIUM PARA GENERAR PDF =====
        generatePDFReport(analysisId) {
          try {
            const history = this.getHistory();
            const analysisItem = history.find((item) => item.id === analysisId);

            if (!analysisItem) {
              this.showNotification(
                "error",
                "Error",
                "An√°lisis no encontrado en el historial"
              );
              return;
            }

            this.showNotification(
              "success",
              "Generando PDF Premium",
              "Creando informe completo con gr√°ficos..."
            );

            // Crear documento PDF en formato A4
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("p", "mm", "a4");
            const results = analysisItem.results;

            // Configuraci√≥n de colores y estilos premium
            const colors = {
              primary: [249, 115, 22],
              secondary: [234, 88, 12],
              accent: [251, 146, 60],
              success: [16, 185, 129],
              warning: [245, 158, 11],
              error: [239, 68, 68],
              dark: [31, 41, 55],
              gray: [107, 114, 128],
              light: [248, 250, 252],
              white: [255, 255, 255],
            };

            let currentY = 15;
            const pageWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            const margin = 15;
            const contentWidth = pageWidth - margin * 2;

            // =================== PORTADA PREMIUM ===================
            this.createPDFCover(
              doc,
              analysisItem,
              colors,
              margin,
              contentWidth
            );

            // Nueva p√°gina para contenido
            doc.addPage();
            currentY = 20;

            // =================== √çNDICE ===================
            currentY = this.createPDFIndex(doc, colors, margin, currentY);

            // Nueva p√°gina para m√©tricas
            doc.addPage();
            currentY = 20;

            // =================== RESUMEN EJECUTIVO ===================
            currentY = this.createExecutiveSummary(
              doc,
              results,
              colors,
              margin,
              currentY,
              contentWidth
            );

            // =================== M√âTRICAS PRINCIPALES ===================
            currentY = this.createMainMetrics(
              doc,
              results,
              colors,
              margin,
              currentY,
              contentWidth
            );

            // Verificar espacio para nueva secci√≥n
            if (currentY > 220) {
              doc.addPage();
              currentY = 20;
            }

            // =================== GR√ÅFICOS ===================
            currentY = this.addChartsToPDF(
              doc,
              results,
              colors,
              margin,
              currentY,
              contentWidth
            );

            // =================== AN√ÅLISIS DETALLADO ===================
            currentY = this.createDetailedAnalysis(
              doc,
              results,
              colors,
              margin,
              currentY,
              contentWidth
            );

            // =================== BENCHMARKS ===================
            if (currentY > 200) {
              doc.addPage();
              currentY = 20;
            }
            currentY = this.createBenchmarkSection(
              doc,
              results,
              colors,
              margin,
              currentY,
              contentWidth
            );

            // =================== RECOMENDACIONES ===================
            if (currentY > 200) {
              doc.addPage();
              currentY = 20;
            }
            currentY = this.createRecommendationsSection(
              doc,
              results,
              colors,
              margin,
              currentY,
              contentWidth
            );

            // =================== PIE DE P√ÅGINA EN TODAS LAS P√ÅGINAS ===================
            this.addPageFooters(doc, colors, margin);

            // =================== GUARDAR PDF ===================
            const fileName = `MacPollo_Analytics_Premium_${analysisItem.date.replace(
              /\s/g,
              "_"
            )}_${analysisItem.time.replace(":", "")}.pdf`;
            doc.save(fileName);

            this.showNotification(
              "success",
              "PDF Premium Generado",
              `Informe completo descargado: ${fileName}`
            );
          } catch (error) {
            console.error("Error generando PDF premium:", error);
            this.showNotification(
              "error",
              "Error de Generaci√≥n",
              "No se pudo generar el informe premium. Intenta nuevamente."
            );
          }
        }

        // ===== FUNCIONES AUXILIARES PARA PDF PREMIUM =====

        // Crear portada premium
        createPDFCover(doc, analysisItem, colors, margin, contentWidth) {
          const pageWidth = 210;
          const pageHeight = 297;

          // Fondo degradado simulado con rect√°ngulos
          doc.setFillColor(...colors.primary);
          doc.rect(0, 0, pageWidth, 80, "F");

          doc.setFillColor(249, 115, 22, 0.8);
          doc.rect(0, 60, pageWidth, 40, "F");

          doc.setFillColor(234, 88, 12, 0.6);
          doc.rect(0, 80, pageWidth, 40, "F");

          // Logo y t√≠tulo principal
          doc.setTextColor(...colors.white);
          doc.setFontSize(36);
          doc.setFont("helvetica", "bold");
          doc.text("üêî MacPollo", pageWidth / 2, 35, { align: "center" });

          doc.setFontSize(24);
          doc.setFont("helvetica", "normal");
          doc.text("ANALYTICS", pageWidth / 2, 50, { align: "center" });

          doc.setFontSize(14);
          doc.setTextColor(255, 255, 255, 0.9);
          doc.text(
            "Sistema de An√°lisis de Costos de Limpieza Industrial",
            pageWidth / 2,
            65,
            { align: "center" }
          );

          // Informaci√≥n del reporte
          doc.setFillColor(...colors.white);
          doc.roundedRect(margin, 110, contentWidth, 60, 5, 5, "F");

          doc.setTextColor(...colors.dark);
          doc.setFontSize(18);
          doc.setFont("helvetica", "bold");
          doc.text("üìä INFORME DE AN√ÅLISIS PREMIUM", pageWidth / 2, 125, {
            align: "center",
          });

          doc.setFontSize(12);
          doc.setFont("helvetica", "normal");
          doc.setTextColor(...colors.gray);

          const reportInfo = [
            `üìÖ Fecha del An√°lisis: ${analysisItem.date}`,
            `‚è∞ Hora de Generaci√≥n: ${analysisItem.time}`,
            `üî¢ ID del An√°lisis: ${analysisItem.id.substring(0, 20)}...`,
            `üìã Kilos Procesados: ${analysisItem.results.kilosPollo.toLocaleString(
              "es-CO"
            )} kg`,
            `üí∞ Inversi√≥n Total: ${formatCOP(analysisItem.results.costoTotal)}`,
          ];

          let infoY = 140;
          reportInfo.forEach((info) => {
            doc.text(info, pageWidth / 2, infoY, { align: "center" });
            infoY += 6;
          });

          // M√©tricas destacadas en la portada
          doc.setFillColor(...colors.light);
          doc.roundedRect(margin, 190, contentWidth, 40, 5, 5, "F");

          doc.setTextColor(...colors.primary);
          doc.setFontSize(14);
          doc.setFont("helvetica", "bold");
          doc.text("üéØ RESULTADOS CLAVE", pageWidth / 2, 205, {
            align: "center",
          });

          doc.setFontSize(10);
          doc.setTextColor(...colors.dark);
          doc.setFont("helvetica", "normal");

          const keyMetrics = [
            `Costo por Kg: ${formatCOP(
              analysisItem.results.costoPorKilo
            )} | Eficiencia: ${this.getEfficiencyLabel(
              analysisItem.results.eficienciaCosto
            )}`,
            `Agua por Kg: ${analysisItem.results.litrosAguaPorKilo.toFixed(
              1
            )} L | Eficiencia: ${this.getEfficiencyLabel(
              analysisItem.results.eficienciaAgua
            )}`,
          ];

          let metricsY = 215;
          keyMetrics.forEach((metric) => {
            doc.text(metric, pageWidth / 2, metricsY, { align: "center" });
            metricsY += 6;
          });

          // Footer de portada
          doc.setTextColor(...colors.gray);
          doc.setFontSize(8);
          doc.text(
            "Reporte generado autom√°ticamente por MacPollo Analytics",
            pageWidth / 2,
            280,
            { align: "center" }
          );
          doc.text(
            `¬© 2025 MacPollo Analytics. Todos los derechos reservados.`,
            pageWidth / 2,
            287,
            { align: "center" }
          );
        }

        // Crear √≠ndice
        createPDFIndex(doc, colors, margin, startY) {
          doc.setTextColor(...colors.primary);
          doc.setFontSize(20);
          doc.setFont("helvetica", "bold");
          doc.text("üìã √çNDICE DEL INFORME", margin, startY);

          startY += 15;

          const indexItems = [
            { title: "1. Resumen Ejecutivo", page: "3" },
            { title: "2. M√©tricas Principales", page: "3" },
            { title: "3. An√°lisis Gr√°fico", page: "4" },
            { title: "4. An√°lisis Detallado", page: "5" },
            { title: "5. Comparaci√≥n con Benchmarks", page: "6" },
            { title: "6. Recomendaciones Estrat√©gicas", page: "7" },
            { title: "Anexos y Referencias", page: "8" },
          ];

          doc.setFillColor(...colors.light);
          doc.roundedRect(
            margin,
            startY,
            180,
            indexItems.length * 8 + 10,
            3,
            3,
            "F"
          );

          startY += 8;

          indexItems.forEach((item, index) => {
            doc.setTextColor(...colors.dark);
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            doc.text(`${item.title}`, margin + 5, startY);

            // L√≠nea punteada
            const dots = ".".repeat(
              Math.floor((140 - doc.getTextWidth(item.title)) / 2)
            );
            doc.setTextColor(...colors.gray);
            doc.setFontSize(8);
            doc.text(
              dots,
              margin + 5 + doc.getTextWidth(item.title) + 2,
              startY
            );

            doc.setTextColor(...colors.primary);
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text(item.page, margin + 165, startY);

            startY += 8;
          });

          return startY + 20;
        }

        // Crear resumen ejecutivo
        createExecutiveSummary(
          doc,
          results,
          colors,
          margin,
          startY,
          contentWidth
        ) {
          // T√≠tulo de secci√≥n
          this.createSectionHeader(
            doc,
            "üìà RESUMEN EJECUTIVO",
            colors,
            margin,
            startY
          );
          startY += 15;

          // Caja de resumen
          doc.setFillColor(...colors.light);
          doc.roundedRect(margin, startY, contentWidth, 35, 3, 3, "F");
          doc.setDrawColor(...colors.primary);
          doc.setLineWidth(0.5);
          doc.roundedRect(margin, startY, contentWidth, 35, 3, 3, "S");

          startY += 8;

          doc.setTextColor(...colors.dark);
          doc.setFontSize(11);
          doc.setFont("helvetica", "normal");

          const executiveSummary = [
            `MacPollo proces√≥ ${results.kilosPollo.toLocaleString(
              "es-CO"
            )} kg de pollo con una inversi√≥n total de ${formatCOP(
              results.costoTotal
            )}.`,
            `El costo por kilogramo fue de ${formatCOP(
              results.costoPorKilo
            )}, clasificado como "${this.getEfficiencyLabel(
              results.eficienciaCosto
            )}".`,
            `El consumo de agua fue de ${results.litrosAguaPorKilo.toFixed(
              1
            )} L/kg, clasificado como "${this.getEfficiencyLabel(
              results.eficienciaAgua
            )}".`,
            `Los insumos qu√≠micos representan el ${results.porcentajeInsumos.toFixed(
              1
            )}% del costo total del proceso.`,
          ];

          executiveSummary.forEach((text) => {
            const lines = doc.splitTextToSize(text, contentWidth - 10);
            lines.forEach((line) => {
              doc.text(line, margin + 5, startY);
              startY += 5;
            });
            startY += 2;
          });

          return startY + 10;
        }

        // Crear m√©tricas principales con dise√±o premium
        createMainMetrics(doc, results, colors, margin, startY, contentWidth) {
          this.createSectionHeader(
            doc,
            "üìä M√âTRICAS PRINCIPALES",
            colors,
            margin,
            startY
          );
          startY += 15;

          // Grid de m√©tricas (2x2)
          const metricWidth = (contentWidth - 10) / 2;
          const metricHeight = 25;

          const metrics = [
            {
              title: "Costo por Kilogramo",
              value: formatCOP(results.costoPorKilo),
              efficiency: results.eficienciaCosto,
              icon: "üí∞",
              x: margin,
              y: startY,
            },
            {
              title: "Agua por Kilogramo",
              value: `${results.litrosAguaPorKilo.toFixed(1)} L`,
              efficiency: results.eficienciaAgua,
              icon: "üíß",
              x: margin + metricWidth + 5,
              y: startY,
            },
            {
              title: "Costo Total Proceso",
              value: formatCOP(results.costoTotal),
              efficiency: "good",
              icon: "üìä",
              x: margin,
              y: startY + metricHeight + 5,
            },
            {
              title: "Volumen Total Agua",
              value: `${results.aguaConsumida} m¬≥`,
              efficiency: "good",
              icon: "üåä",
              x: margin + metricWidth + 5,
              y: startY + metricHeight + 5,
            },
          ];

          metrics.forEach((metric) => {
            // Fondo de m√©trica con color seg√∫n eficiencia
            let bgColor = colors.light;
            if (metric.efficiency === "excellent") bgColor = [236, 253, 245];
            else if (metric.efficiency === "good") bgColor = [254, 249, 195];
            else if (metric.efficiency === "poor") bgColor = [254, 242, 242];

            doc.setFillColor(...bgColor);
            doc.roundedRect(
              metric.x,
              metric.y,
              metricWidth,
              metricHeight,
              3,
              3,
              "F"
            );

            // Borde
            doc.setDrawColor(...colors.primary);
            doc.setLineWidth(0.3);
            doc.roundedRect(
              metric.x,
              metric.y,
              metricWidth,
              metricHeight,
              3,
              3,
              "S"
            );

            // Contenido
            doc.setTextColor(...colors.primary);
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text(
              `${metric.icon} ${metric.title}`,
              metric.x + 3,
              metric.y + 6
            );

            doc.setTextColor(...colors.dark);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text(metric.value, metric.x + 3, metric.y + 14);

            // Badge de eficiencia
            if (metric.efficiency !== "good") {
              const efficiencyLabel = this.getEfficiencyLabel(
                metric.efficiency
              );
              doc.setFontSize(8);
              doc.setFont("helvetica", "normal");

              let badgeColor = colors.success;
              if (metric.efficiency === "poor") badgeColor = colors.error;
              else if (metric.efficiency === "regular")
                badgeColor = colors.warning;

              doc.setTextColor(...badgeColor);
              doc.text(efficiencyLabel, metric.x + 3, metric.y + 21);
            }
          });

          return startY + metricHeight * 2 + 20;
        }

        // A√±adir gr√°ficos al PDF
        addChartsToPDF(doc, results, colors, margin, startY, contentWidth) {
          this.createSectionHeader(
            doc,
            "üìà AN√ÅLISIS GR√ÅFICO",
            colors,
            margin,
            startY
          );
          startY += 15;

          try {
            // Gr√°fico de distribuci√≥n de costos (Pie Chart)
            if (AppState.charts.pie) {
              const pieCanvas = AppState.charts.pie.canvas;
              const pieImgData = pieCanvas.toDataURL("image/png", 1.0);

              doc.setFillColor(...colors.light);
              doc.roundedRect(margin, startY, contentWidth, 60, 3, 3, "F");

              doc.setTextColor(...colors.dark);
              doc.setFontSize(12);
              doc.setFont("helvetica", "bold");
              doc.text("üç∞ Distribuci√≥n de Costos", margin + 5, startY + 8);

              // A√±adir imagen del gr√°fico
              doc.addImage(pieImgData, "PNG", margin + 5, startY + 12, 80, 40);

              // Leyenda del gr√°fico
              doc.setFontSize(9);
              doc.setFont("helvetica", "normal");
              doc.setTextColor(...colors.gray);

              const legendY = startY + 20;
              doc.text(
                `üíß Agua: ${formatCOP(
                  results.costoTotalAgua
                )} (${results.porcentajeAgua.toFixed(1)}%)`,
                margin + 90,
                legendY
              );
              doc.text(
                `üß™ Insumos: ${formatCOP(
                  results.costoInsumos
                )} (${results.porcentajeInsumos.toFixed(1)}%)`,
                margin + 90,
                legendY + 8
              );
              doc.text(
                `üí∞ Total: ${formatCOP(results.costoTotal)}`,
                margin + 90,
                legendY + 16
              );

              startY += 70;
            }

            // Nueva p√°gina si es necesario
            if (startY > 200) {
              doc.addPage();
              startY = 20;
            }

            // Gr√°fico de comparaci√≥n con benchmarks
            if (AppState.charts.bar) {
              const barCanvas = AppState.charts.bar.canvas;
              const barImgData = barCanvas.toDataURL("image/png", 1.0);

              doc.setFillColor(...colors.light);
              doc.roundedRect(margin, startY, contentWidth, 70, 3, 3, "F");

              doc.setTextColor(...colors.dark);
              doc.setFontSize(12);
              doc.setFont("helvetica", "bold");
              doc.text(
                "üìä Comparaci√≥n vs Benchmarks de Industria",
                margin + 5,
                startY + 8
              );

              doc.addImage(
                barImgData,
                "PNG",
                margin + 5,
                startY + 12,
                contentWidth - 10,
                50
              );

              startY += 80;
            }
          } catch (error) {
            console.error("Error a√±adiendo gr√°ficos al PDF:", error);
            // Continuar sin gr√°ficos si hay error
            doc.setTextColor(...colors.gray);
            doc.setFontSize(10);
            doc.text(
              "(Gr√°ficos no disponibles - aseg√∫rate de generar los gr√°ficos antes del PDF)",
              margin,
              startY
            );
            startY += 15;
          }

          return startY;
        }

        // Crear an√°lisis detallado
        createDetailedAnalysis(
          doc,
          results,
          colors,
          margin,
          startY,
          contentWidth
        ) {
          this.createSectionHeader(
            doc,
            "üîç AN√ÅLISIS DETALLADO",
            colors,
            margin,
            startY
          );
          startY += 15;

          // Tabla de desglose de costos
          startY = this.createPremiumTable(
            doc,
            [
              ["Concepto", "Valor", "Porcentaje"],
              [
                "Costo de Agua",
                formatCOP(results.costoTotalAgua),
                `${results.porcentajeAgua.toFixed(1)}%`,
              ],
              [
                "Insumos Qu√≠micos",
                formatCOP(results.costoInsumos),
                `${results.porcentajeInsumos.toFixed(1)}%`,
              ],
              ["TOTAL MACPOLLO", formatCOP(results.costoTotal), "100.0%"],
            ],
            colors,
            margin,
            startY,
            contentWidth,
            "üí∞ Desglose de Costos"
          );

          startY += 10;

          // An√°lisis de eficiencia
          const efficiencyAnalysis = this.generateEfficiencyAnalysis(results);

          doc.setFillColor(...colors.light);
          doc.roundedRect(margin, startY, contentWidth, 30, 3, 3, "F");

          doc.setTextColor(...colors.primary);
          doc.setFontSize(12);
          doc.setFont("helvetica", "bold");
          doc.text("‚ö° An√°lisis de Eficiencia", margin + 5, startY + 8);

          doc.setTextColor(...colors.dark);
          doc.setFontSize(10);
          doc.setFont("helvetica", "normal");

          let analysisY = startY + 16;
          efficiencyAnalysis.forEach((analysis) => {
            const lines = doc.splitTextToSize(analysis, contentWidth - 10);
            lines.forEach((line) => {
              doc.text(line, margin + 5, analysisY);
              analysisY += 4;
            });
          });

          return analysisY + 10;
        }

        // Crear secci√≥n de benchmarks
        createBenchmarkSection(
          doc,
          results,
          colors,
          margin,
          startY,
          contentWidth
        ) {
          this.createSectionHeader(
            doc,
            "üéØ COMPARACI√ìN CON BENCHMARKS",
            colors,
            margin,
            startY
          );
          startY += 15;

          return this.createPremiumTable(
            doc,
            [
              [
                "Indicador",
                "√ìptimo",
                "Promedio Industria",
                "MacPollo",
                "Estado",
              ],
              [
                "Costo por kg",
                formatCOP(results.benchmarks.costoPorKiloOptimo),
                formatCOP(results.benchmarks.costoPorKiloPromedio),
                formatCOP(results.costoPorKilo),
                this.getEfficiencyLabel(results.eficienciaCosto),
              ],
              [
                "Agua por kg",
                `${results.benchmarks.aguaPorKiloOptimo} L`,
                `${results.benchmarks.aguaPorKiloPromedio} L`,
                `${results.litrosAguaPorKilo.toFixed(1)} L`,
                this.getEfficiencyLabel(results.eficienciaAgua),
              ],
            ],
            colors,
            margin,
            startY,
            contentWidth,
            "üìã Comparaci√≥n Detallada"
          );
        }

        // Crear secci√≥n de recomendaciones
        createRecommendationsSection(
          doc,
          results,
          colors,
          margin,
          startY,
          contentWidth
        ) {
          this.createSectionHeader(
            doc,
            "üí° RECOMENDACIONES ESTRAT√âGICAS",
            colors,
            margin,
            startY
          );
          startY += 15;

          const recommendations = this.generateRecommendationsForPDF(results);

          recommendations.forEach((rec, index) => {
            // Verificar espacio
            if (startY > 240) {
              doc.addPage();
              startY = 20;
            }

            // Caja de recomendaci√≥n
            let bgColor = colors.light;
            let iconColor = colors.primary;

            if (
              rec.title.includes("Cr√≠tica") ||
              rec.title.includes("Oportunidad")
            ) {
              bgColor = [254, 242, 242];
              iconColor = colors.error;
            } else if (
              rec.title.includes("Excelencia") ||
              rec.title.includes("Optimizado")
            ) {
              bgColor = [236, 253, 245];
              iconColor = colors.success;
            }

            doc.setFillColor(...bgColor);
            doc.roundedRect(margin, startY, contentWidth, 20, 3, 3, "F");

            doc.setDrawColor(...iconColor);
            doc.setLineWidth(0.5);
            doc.roundedRect(margin, startY, contentWidth, 20, 3, 3, "S");

            // Contenido
            doc.setTextColor(...iconColor);
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text(`${index + 1}. ${rec.title}`, margin + 3, startY + 7);

            doc.setTextColor(...colors.dark);
            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");

            const descLines = doc.splitTextToSize(
              rec.description,
              contentWidth - 6
            );
            let descY = startY + 13;
            descLines.forEach((line) => {
              doc.text(line, margin + 3, descY);
              descY += 4;
            });

            startY += 25;
          });

          return startY;
        }

        // Crear encabezado de secci√≥n premium
        createSectionHeader(doc, title, colors, margin, y) {
          doc.setFillColor(...colors.primary);
          doc.rect(margin, y, 180, 8, "F");

          doc.setTextColor(...colors.white);
          doc.setFontSize(14);
          doc.setFont("helvetica", "bold");
          doc.text(title, margin + 3, y + 6);
        }

        // Crear tabla premium
        createPremiumTable(
          doc,
          data,
          colors,
          margin,
          startY,
          contentWidth,
          title = ""
        ) {
          if (title) {
            doc.setTextColor(...colors.primary);
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text(title, margin, startY);
            startY += 8;
          }

          const rowHeight = 6;
          const colWidth = contentWidth / data[0].length;

          data.forEach((row, rowIndex) => {
            row.forEach((cell, colIndex) => {
              const cellX = margin + colIndex * colWidth;
              const cellY = startY + rowIndex * rowHeight;

              // Fondo
              if (rowIndex === 0) {
                doc.setFillColor(...colors.primary);
                doc.rect(cellX, cellY, colWidth, rowHeight, "F");
                doc.setTextColor(...colors.white);
                doc.setFontSize(9);
                doc.setFont("helvetica", "bold");
              } else {
                if (rowIndex % 2 === 0) {
                  doc.setFillColor(248, 250, 252);
                  doc.rect(cellX, cellY, colWidth, rowHeight, "F");
                }
                doc.setTextColor(...colors.dark);
                doc.setFontSize(8);
                doc.setFont("helvetica", "normal");
              }

              // Bordes
              doc.setDrawColor(...colors.gray);
              doc.setLineWidth(0.2);
              doc.rect(cellX, cellY, colWidth, rowHeight);

              // Texto
              doc.text(cell.toString(), cellX + 1, cellY + 4);
            });
          });

          return startY + data.length * rowHeight + 10;
        }

        // A√±adir pie de p√°gina a todas las p√°ginas
        addPageFooters(doc, colors, margin) {
          const pageCount = doc.getNumberOfPages();

          for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);

            // L√≠nea divisoria
            doc.setDrawColor(...colors.gray);
            doc.setLineWidth(0.3);
            doc.line(margin, 280, 210 - margin, 280);

            // Texto del pie
            doc.setTextColor(...colors.gray);
            doc.setFontSize(8);
            doc.setFont("helvetica", "normal");

            doc.text(
              "MacPollo Analytics - Sistema de An√°lisis de Costos de Limpieza Industrial",
              margin,
              285
            );
            doc.text(`P√°gina ${i} de ${pageCount}`, 210 - margin, 285, {
              align: "right",
            });
            doc.text(
              `Generado el ${new Date().toLocaleDateString(
                "es-CO"
              )} - ¬© 2025 MacPollo Analytics`,
              margin,
              290
            );
          }
        }

        // Generar an√°lisis de eficiencia para PDF
        generateEfficiencyAnalysis(results) {
          let analysis = [];

          if (results.ahorroVsPromedio > 0) {
            analysis.push(
              `‚úÖ EXCELENTE: MacPollo opera ${results.ahorroVsPromedio.toFixed(
                1
              )}% m√°s eficientemente que el promedio de la industria.`
            );
          } else {
            analysis.push(
              `‚ö†Ô∏è OPORTUNIDAD: MacPollo tiene un costo ${Math.abs(
                results.ahorroVsPromedio
              ).toFixed(1)}% mayor que el promedio de la industria.`
            );
          }

          if (results.litrosAguaPorKilo <= 20) {
            analysis.push(
              `üíß Uso de agua √ìPTIMO: ${results.litrosAguaPorKilo.toFixed(
                1
              )} L/kg est√° dentro del rango ideal (‚â§20 L/kg).`
            );
          } else if (results.litrosAguaPorKilo <= 30) {
            analysis.push(
              `üíß Uso de agua BUENO: ${results.litrosAguaPorKilo.toFixed(
                1
              )} L/kg est√° en rango aceptable (20-30 L/kg).`
            );
          } else {
            analysis.push(
              `üíß Uso de agua MEJORABLE: ${results.litrosAguaPorKilo.toFixed(
                1
              )} L/kg supera los est√°ndares recomendados (>30 L/kg).`
            );
          }

          analysis.push(
            `üí∞ Distribuci√≥n de costos: Agua ${results.porcentajeAgua.toFixed(
              1
            )}% | Insumos ${results.porcentajeInsumos.toFixed(1)}%`
          );

          return analysis;
        }

        // M√©todo auxiliar para generar recomendaciones para PDF
        generateRecommendationsForPDF(results) {
          let recommendations = [];

          if (results.litrosAguaPorKilo > 35) {
            recommendations.push({
              title: "Optimizaci√≥n Cr√≠tica de Agua",
              description:
                "Se recomienda implementar urgentemente sistemas de recirculaci√≥n de agua o tecnolog√≠as de limpieza m√°s eficientes para reducir el consumo por debajo de 30 L/kg.",
            });
          } else if (results.litrosAguaPorKilo > 25) {
            recommendations.push({
              title: "Mejora del Uso de Agua",
              description:
                "Evaluar la implementaci√≥n de sistemas de ahorro de agua m√°s eficientes. Considerar tecnolog√≠as de atomizaci√≥n o limpieza a alta presi√≥n.",
            });
          }

          if (
            results.costoPorKilo > AppConfig.benchmarks.costoPorKiloPromedio
          ) {
            recommendations.push({
              title: "Optimizaci√≥n de Costos",
              description:
                "Analizar proveedores alternativos para insumos qu√≠micos y evaluar la optimizaci√≥n de procesos de limpieza para reducir costos operativos.",
            });
          }

          if (results.porcentajeInsumos > 70) {
            recommendations.push({
              title: "An√°lisis de Insumos Qu√≠micos",
              description: `Los insumos representan ${results.porcentajeInsumos.toFixed(
                1
              )}% del costo total. Evaluar concentraciones y eficiencia de productos utilizados.`,
            });
          }

          if (results.ahorroVsPromedio > 10) {
            recommendations.push({
              title: "Excelencia Operativa",
              description:
                "MacPollo est√° operando significativamente por encima de los est√°ndares de la industria. Considerar documentar y replicar estas mejores pr√°cticas.",
            });
          }

          if (
            results.eficienciaAgua === "excellent" &&
            results.eficienciaCosto === "excellent"
          ) {
            recommendations.push({
              title: "Proceso Altamente Optimizado",
              description:
                "El proceso actual muestra excelencia en ambas m√©tricas clave. Mantener estos est√°ndares y considerar auditor√≠as peri√≥dicas.",
            });
          }

          if (recommendations.length === 0) {
            recommendations.push({
              title: "Proceso Eficiente",
              description:
                "MacPollo muestra indicadores de eficiencia satisfactorios. Continuar con el monitoreo regular y mantener los est√°ndares actuales.",
            });
          }

          return recommendations;
        }

        // ===== RESTO DE LOS M√âTODOS ORIGINALES =====

        // Validaci√≥n de campos
        validateField(input) {
          const fieldName = input.name;
          const value = parseFloat(input.value);
          const config = AppConfig.validation[fieldName];

          this.clearFieldError(input);

          if (!input.value.trim()) {
            if (input.required) {
              this.setFieldError(input, "Este campo es obligatorio");
              return false;
            }
            return true;
          }

          if (isNaN(value)) {
            this.setFieldError(input, "Debe ser un n√∫mero v√°lido");
            return false;
          }

          if (config) {
            if (value < config.min) {
              this.setFieldError(
                input,
                `El valor m√≠nimo es ${config.min.toLocaleString("es-CO")}`
              );
              return false;
            }
            if (value > config.max) {
              this.setFieldError(
                input,
                `El valor m√°ximo es ${config.max.toLocaleString("es-CO")}`
              );
              return false;
            }
          }

          // Validaciones espec√≠ficas
          if (fieldName === "aguaConsumida" || fieldName === "kilosPollo") {
            if (value <= 0) {
              this.setFieldError(input, "Debe ser mayor a 0");
              return false;
            }
          }

          this.setFieldSuccess(input);
          return true;
        }

        setFieldError(input, message) {
          const field = input.closest(".form-field");
          const errorElement = field.querySelector(".form-error");

          field.classList.add("error");
          field.classList.remove("success");
          input.classList.add("error");

          if (errorElement) {
            errorElement.textContent = message;
          }
        }

        setFieldSuccess(input) {
          const field = input.closest(".form-field");

          field.classList.remove("error");
          field.classList.add("success");
          input.classList.remove("error");
        }

        clearFieldError(input) {
          const field = input.closest(".form-field");
          const errorElement = field.querySelector(".form-error");

          field.classList.remove("error", "success");
          input.classList.remove("error");

          if (errorElement) {
            errorElement.textContent = "";
          }
        }

        // Manejo del formulario
        async handleSubmit(e) {
          e.preventDefault();

          if (!this.validateForm()) {
            this.showNotification(
              "error",
              "Datos Inv√°lidos",
              "Por favor, corrige los errores antes de continuar"
            );
            return;
          }

          const formData = this.collectFormData();

          try {
            await this.calculateProcess(formData);
          } catch (error) {
            console.error("Error en c√°lculo:", error);
            this.showNotification(
              "error",
              "Error de C√°lculo",
              "No se pudo procesar el an√°lisis. Verifica los datos e intenta nuevamente."
            );
          }
        }

        validateForm() {
          const form = document.getElementById("processForm");
          const inputs = form.querySelectorAll("input[required]");
          let isValid = true;

          inputs.forEach((input) => {
            if (!this.validateField(input)) {
              isValid = false;
            }
          });

          return isValid;
        }

        collectFormData() {
          const formData = new FormData(document.getElementById("processForm"));

          return {
            kilosPollo: parseFloat(formData.get("kilosPollo")) || 0,
            aguaConsumida: parseFloat(formData.get("aguaConsumida")) || 0,
            costoAgua: parseFloat(formData.get("costoAgua")) || 0,
            costoInsumos: parseFloat(formData.get("costoInsumos")) || 0,
            detalleInsumos: formData.get("detalleInsumos") || "",
          };
        }

        async calculateProcess(data) {
          const calculateBtn = document.getElementById("calculateBtn");
          const resultsPanel = document.getElementById("resultsPanel");

          // UI de carga
          calculateBtn.classList.add("btn-loading");
          calculateBtn.disabled = true;

          // Overlay de carga en resultados
          if (!document.querySelector(".loading-overlay")) {
            const overlay = document.createElement("div");
            overlay.className = "loading-overlay";
            overlay.innerHTML = '<div class="loading-spinner"></div>';
            resultsPanel.appendChild(overlay);
          }

          try {
            // Simular procesamiento as√≠ncrono
            await this.delay(1500);

            const results = this.performCalculations(data);
            AppState.currentResults = results;

            this.displayResults(results);

            // Guardar autom√°ticamente en historial
            this.saveToHistory(results);

            this.showNotification(
              "success",
              "An√°lisis Completado",
              "Los resultados se han calculado exitosamente para MacPollo"
            );
          } finally {
            // Cleanup UI
            calculateBtn.classList.remove("btn-loading");
            calculateBtn.disabled = false;

            const overlay = document.querySelector(".loading-overlay");
            if (overlay) {
              overlay.remove();
            }
          }
        }

        performCalculations(data) {
          const { kilosPollo, aguaConsumida, costoAgua, costoInsumos } = data;

          // C√°lculos principales
          const costoTotalAgua = aguaConsumida * costoAgua;
          const costoTotal = costoTotalAgua + costoInsumos;
          const costoPorKilo = costoTotal / kilosPollo;
          const aguaPorKilo = aguaConsumida / kilosPollo;
          const litrosAguaPorKilo = aguaPorKilo * 1000;

          // An√°lisis de eficiencia
          const eficienciaAgua = this.calculateEfficiency(
            litrosAguaPorKilo,
            "agua"
          );
          const eficienciaCosto = this.calculateEfficiency(
            costoPorKilo,
            "costo"
          );

          // Porcentajes
          const porcentajeAgua = (costoTotalAgua / costoTotal) * 100;
          const porcentajeInsumos = (costoInsumos / costoTotal) * 100;

          // Comparaci√≥n con benchmarks
          const ahorroVsPromedio =
            ((AppConfig.benchmarks.costoPorKiloPromedio - costoPorKilo) /
              AppConfig.benchmarks.costoPorKiloPromedio) *
            100;
          const ahorroAguaVsPromedio =
            ((AppConfig.benchmarks.aguaPorKiloPromedio - litrosAguaPorKilo) /
              AppConfig.benchmarks.aguaPorKiloPromedio) *
            100;

          return {
            ...data,
            costoTotal,
            costoTotalAgua,
            costoPorKilo,
            aguaPorKilo,
            litrosAguaPorKilo,
            eficienciaAgua,
            eficienciaCosto,
            porcentajeAgua,
            porcentajeInsumos,
            ahorroVsPromedio,
            ahorroAguaVsPromedio,
            benchmarks: AppConfig.benchmarks,
          };
        }

        calculateEfficiency(value, type) {
          if (type === "agua") {
            if (value <= 15) return "excellent";
            if (value <= 25) return "good";
            if (value <= 35) return "regular";
            return "poor";
          }

          if (type === "costo") {
            if (value <= AppConfig.benchmarks.costoPorKiloOptimo)
              return "excellent";
            if (value <= AppConfig.benchmarks.costoPorKiloPromedio)
              return "good";
            if (value <= AppConfig.benchmarks.costoPorKiloPromedio * 1.2)
              return "regular";
            return "poor";
          }

          return "regular";
        }

        displayResults(results) {
          const content = document.getElementById("resultsContent");

          const html = `
      <div class="results-tabs">
        <button class="tab-button active" data-tab="metrics">üìä M√©tricas</button>
        <button class="tab-button" data-tab="charts">üìà Gr√°ficos</button>
        <button class="tab-button" data-tab="analysis">üîç An√°lisis</button>
        <button class="tab-button" data-tab="history">üïí Historial</button>
      </div>

      <div class="tab-content active" id="tab-metrics">
        ${this.renderMetricsTab(results)}
      </div>

      <div class="tab-content" id="tab-charts">
        ${this.renderChartsTab(results)}
      </div>

      <div class="tab-content" id="tab-analysis">
        ${this.renderAnalysisTab(results)}
      </div>

      <div class="tab-content" id="tab-history">
        ${this.renderHistoryTab()}
      </div>
    `;

          content.innerHTML = html;
          this.setupTabs();

          // Crear gr√°ficos despu√©s de un delay para asegurar que el DOM est√© listo
          setTimeout(() => this.createCharts(results), 100);
        }

        renderMetricsTab(results) {
          return `
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-icon">üí∞</span>
            <span class="metric-label">Costo por Kilogramo</span>
          </div>
          <div class="metric-value">${formatCOP(results.costoPorKilo)}</div>
          <div class="metric-description">Costo total del proceso dividido entre kilos procesados</div>
          <div class="metric-badge badge-${results.eficienciaCosto}">
            ${this.getEfficiencyLabel(results.eficienciaCosto)}
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-icon">üíß</span>
            <span class="metric-label">Agua por Kilogramo</span>
          </div>
          <div class="metric-value">${results.litrosAguaPorKilo.toFixed(
            1
          )} L</div>
          <div class="metric-description">Litros de agua consumidos por kilogramo de pollo</div>
          <div class="metric-badge badge-${results.eficienciaAgua}">
            ${this.getEfficiencyLabel(results.eficienciaAgua)}
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-icon">üìä</span>
            <span class="metric-label">Costo Total</span>
          </div>
          <div class="metric-value">${formatCOP(results.costoTotal)}</div>
          <div class="metric-description">Inversi√≥n total para procesar ${results.kilosPollo.toLocaleString(
            "es-CO"
          )} kg</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-icon">üåä</span>
            <span class="metric-label">Volumen de Agua</span>
          </div>
          <div class="metric-value">${results.aguaConsumida} m¬≥</div>
          <div class="metric-description">Metros c√∫bicos totales consumidos</div>
        </div>
      </div>

      <div class="analysis-section">
        <div class="analysis-header">
          <span>üíº</span>
          <h3 class="analysis-title">Desglose de Costos</h3>
        </div>
        <div class="benchmark-list">
          <div class="benchmark-item">
            <span class="benchmark-label">üíß Agua (${
              results.aguaConsumida
            } m¬≥)</span>
            <span class="benchmark-value">${formatCOP(
              results.costoTotalAgua
            )} (${results.porcentajeAgua.toFixed(1)}%)</span>
          </div>
          <div class="benchmark-item">
            <span class="benchmark-label">üß™ Insumos Qu√≠micos</span>
            <span class="benchmark-value">${formatCOP(
              results.costoInsumos
            )} (${results.porcentajeInsumos.toFixed(1)}%)</span>
          </div>
          <div class="benchmark-item benchmark-highlight">
            <span class="benchmark-label"><strong>üí∞ TOTAL MacPollo</strong></span>
            <span class="benchmark-value"><strong>${formatCOP(
              results.costoTotal
            )}</strong></span>
          </div>
        </div>
      </div>
    `;
        }

        renderChartsTab(results) {
          return `
      <div class="charts-grid">
        <div class="chart-container">
          <div class="chart-header">
            <span>üç∞</span>
            <h3 class="chart-title">Distribuci√≥n de Costos</h3>
          </div>
          <div class="chart-wrapper">
            <canvas id="pieChart"></canvas>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <span>üìä</span>
            <h3 class="chart-title">Comparativa vs Benchmarks</h3>
          </div>
          <div class="chart-wrapper">
            <canvas id="barChart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <span>üìà</span>
          <h3 class="chart-title">An√°lisis de Eficiencia MacPollo</h3>
        </div>
        <div class="chart-wrapper" style="height: 250px;">
          <canvas id="efficiencyChart"></canvas>
        </div>
      </div>
    `;
        }

        renderAnalysisTab(results) {
          return `
      <div class="analysis-section">
        <div class="analysis-header">
          <span>üéØ</span>
          <h3 class="analysis-title">Benchmarks de Industria Av√≠cola</h3>
        </div>
        <div class="benchmark-list">
          <div class="benchmark-item">
            <span class="benchmark-label">Costo √ìptimo por Kg</span>
            <span class="benchmark-value">${formatCOP(
              results.benchmarks.costoPorKiloOptimo
            )}</span>
          </div>
          <div class="benchmark-item">
            <span class="benchmark-label">Costo Promedio por Kg</span>
            <span class="benchmark-value">${formatCOP(
              results.benchmarks.costoPorKiloPromedio
            )}</span>
          </div>
          <div class="benchmark-item benchmark-highlight">
            <span class="benchmark-label">Costo MacPollo por Kg</span>
            <span class="benchmark-value">${formatCOP(
              results.costoPorKilo
            )}</span>
          </div>
          ${
            results.ahorroVsPromedio > 0
              ? `
              <div class="benchmark-item" style="border-color: var(--success-500); background: var(--success-50);">
                <span class="benchmark-label">‚úÖ Ahorro vs Promedio</span>
                <span class="benchmark-value" style="color: var(--success-600);">${results.ahorroVsPromedio.toFixed(
                  1
                )}% menos</span>
              </div>
            `
              : `
              <div class="benchmark-item" style="border-color: var(--error-500); background: var(--error-50);">
                <span class="benchmark-label">‚ö†Ô∏è Diferencia vs Promedio</span>
                <span class="benchmark-value" style="color: var(--error-600);">${Math.abs(
                  results.ahorroVsPromedio
                ).toFixed(1)}% m√°s</span>
              </div>
            `
          }
        </div>
      </div>

      <div class="analysis-section">
        <div class="analysis-header">
          <span>üîç</span>
          <h3 class="analysis-title">An√°lisis de Eficiencia de Agua</h3>
        </div>
        <div class="benchmark-list">
          <div class="benchmark-item">
            <span class="benchmark-label">Uso √ìptimo de Agua</span>
            <span class="benchmark-value">${
              results.benchmarks.aguaPorKiloOptimo
            } L/kg</span>
          </div>
          <div class="benchmark-item">
            <span class="benchmark-label">Uso Promedio de Agua</span>
            <span class="benchmark-value">${
              results.benchmarks.aguaPorKiloPromedio
            } L/kg</span>
          </div>
          <div class="benchmark-item benchmark-highlight">
            <span class="benchmark-label">Uso MacPollo</span>
            <span class="benchmark-value">${results.litrosAguaPorKilo.toFixed(
              1
            )} L/kg</span>
          </div>
        </div>
      </div>

      ${
        results.detalleInsumos
          ? `
          <div class="analysis-section">
            <div class="analysis-header">
              <span>üß™</span>
              <h3 class="analysis-title">Detalle de Insumos MacPollo</h3>
            </div>
            <div style="background: var(--surface-secondary); padding: var(--space-4); border-radius: var(--radius); color: var(--text-secondary); line-height: 1.6; border: 1px solid var(--border);">
              ${results.detalleInsumos}
            </div>
          </div>
        `
          : ""
      }

      <div class="analysis-section">
        <div class="analysis-header">
          <span>üí°</span>
          <h3 class="analysis-title">Recomendaciones para MacPollo</h3>
        </div>
        <div class="benchmark-list">
          ${this.generateRecommendations(results)}
        </div>
      </div>
    `;
        }

        generateRecommendations(results) {
          let recommendations = [];

          if (results.litrosAguaPorKilo > 35) {
            recommendations.push({
              type: "warning",
              title: "Optimizaci√≥n de Agua Cr√≠tica",
              description:
                "Implementar sistemas de recirculaci√≥n o cambiar tecnolog√≠a de limpieza",
            });
          } else if (results.litrosAguaPorKilo > 25) {
            recommendations.push({
              type: "info",
              title: "Mejora del Uso de Agua",
              description:
                "Evaluar sistemas de ahorro de agua m√°s eficientes para MacPollo",
            });
          }

          if (
            results.costoPorKilo > AppConfig.benchmarks.costoPorKiloPromedio
          ) {
            recommendations.push({
              type: "warning",
              title: "Oportunidad de Reducci√≥n de Costos",
              description:
                "Analizar proveedores alternativos y optimizar procesos de limpieza",
            });
          }

          if (results.porcentajeInsumos > 70) {
            recommendations.push({
              type: "info",
              title: "An√°lisis de Insumos",
              description: `Los insumos representan ${results.porcentajeInsumos.toFixed(
                1
              )}% del costo total de limpieza`,
            });
          }

          if (results.ahorroVsPromedio > 10) {
            recommendations.push({
              type: "success",
              title: "Proceso Altamente Eficiente",
              description:
                "MacPollo est√° operando por encima de los est√°ndares de la industria",
            });
          }

          if (recommendations.length === 0) {
            recommendations.push({
              type: "success",
              title: "Proceso Eficiente",
              description:
                "MacPollo muestra indicadores de eficiencia satisfactorios",
            });
          }

          return recommendations
            .map(
              (rec) => `
        <div class="benchmark-item">
          <span class="benchmark-label">${
            rec.type === "success" ? "‚úÖ" : rec.type === "warning" ? "‚ö†Ô∏è" : "‚ÑπÔ∏è"
          } ${rec.title}</span>
          <span class="benchmark-value">${rec.description}</span>
        </div>
      `
            )
            .join("");
        }

        setupTabs() {
          const tabButtons = document.querySelectorAll(".tab-button");
          const tabContents = document.querySelectorAll(".tab-content");

          tabButtons.forEach((button) => {
            button.addEventListener("click", () => {
              const tabName = button.dataset.tab;

              // Actualizar botones
              tabButtons.forEach((btn) => btn.classList.remove("active"));
              button.classList.add("active");

              // Actualizar contenido
              tabContents.forEach((content) =>
                content.classList.remove("active")
              );
              const targetTab = document.getElementById(`tab-${tabName}`);

              if (targetTab) {
                targetTab.classList.add("active");
              }

              // L√≥gica espec√≠fica por pesta√±a
              if (tabName === "charts" && AppState.currentResults) {
                setTimeout(
                  () => this.createCharts(AppState.currentResults),
                  100
                );
              } else if (tabName === "history") {
                // Actualizar contenido del historial cuando se active la pesta√±a
                const historyTab = document.getElementById("tab-history");
                if (historyTab) {
                  historyTab.innerHTML = this.renderHistoryTab();
                }
              }
            });
          });
        }

        createCharts(results) {
          this.destroyCharts();

          const isDark = AppState.theme === "dark";
          const textColor = isDark ? "#e2e8f0" : "#4b5563";
          const gridColor = isDark ? "#4b5563" : "#e5e7eb";

          // Configuraci√≥n base para gr√°ficos
          const baseConfig = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: {
                  color: textColor,
                  font: {
                    family: "'Inter', sans-serif",
                  },
                },
              },
            },
          };

          // Gr√°fico de distribuci√≥n (Doughnut)
          const pieCtx = document.getElementById("pieChart");
          if (pieCtx) {
            AppState.charts.pie = new Chart(pieCtx, {
              type: "doughnut",
              data: {
                labels: ["Agua", "Insumos Qu√≠micos"],
                datasets: [
                  {
                    data: [results.costoTotalAgua, results.costoInsumos],
                    backgroundColor: ["#f97316", "#ea580c"],
                    borderWidth: 0,
                    cutout: "60%",
                  },
                ],
              },
              options: {
                ...baseConfig,
                plugins: {
                  ...baseConfig.plugins,
                  tooltip: {
                    callbacks: {
                      label: (context) => {
                        const percentage = (
                          (context.parsed / results.costoTotal) *
                          100
                        ).toFixed(1);
                        return `${context.label}: ${formatCOP(
                          context.parsed
                        )} (${percentage}%)`;
                      },
                    },
                  },
                },
              },
            });
          }

          // Gr√°fico de comparaci√≥n (Bar)
          const barCtx = document.getElementById("barChart");
          if (barCtx) {
            AppState.charts.bar = new Chart(barCtx, {
              type: "bar",
              data: {
                labels: ["Costo por Kg (COP)", "Agua por Kg (L)"],
                datasets: [
                  {
                    label: "√ìptimo",
                    data: [
                      results.benchmarks.costoPorKiloOptimo,
                      results.benchmarks.aguaPorKiloOptimo,
                    ],
                    backgroundColor: "#10b981",
                    borderRadius: 6,
                  },
                  {
                    label: "Promedio Industria",
                    data: [
                      results.benchmarks.costoPorKiloPromedio,
                      results.benchmarks.aguaPorKiloPromedio,
                    ],
                    backgroundColor: "#f59e0b",
                    borderRadius: 6,
                  },
                  {
                    label: "MacPollo",
                    data: [results.costoPorKilo, results.litrosAguaPorKilo],
                    backgroundColor: "#f97316",
                    borderRadius: 6,
                  },
                ],
              },
              options: {
                ...baseConfig,
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      color: textColor,
                      font: {
                        family: "'Inter', sans-serif",
                      },
                    },
                    grid: { color: gridColor },
                  },
                  x: {
                    ticks: {
                      color: textColor,
                      font: {
                        family: "'Inter', sans-serif",
                      },
                    },
                    grid: { color: gridColor },
                  },
                },
              },
            });
          }

          // Gr√°fico de eficiencia (Radar)
          const effCtx = document.getElementById("efficiencyChart");
          if (effCtx) {
            const efficiencyScores = {
              agua: this.getEfficiencyScore(results.eficienciaAgua),
              costo: this.getEfficiencyScore(results.eficienciaCosto),
              general:
                (this.getEfficiencyScore(results.eficienciaAgua) +
                  this.getEfficiencyScore(results.eficienciaCosto)) /
                2,
            };

            AppState.charts.efficiency = new Chart(effCtx, {
              type: "radar",
              data: {
                labels: [
                  "Eficiencia de Agua",
                  "Eficiencia de Costo",
                  "Eficiencia General",
                ],
                datasets: [
                  {
                    label: "MacPollo (%)",
                    data: [
                      efficiencyScores.agua,
                      efficiencyScores.costo,
                      efficiencyScores.general,
                    ],
                    borderColor: "#f97316",
                    backgroundColor: "rgba(249, 115, 22, 0.1)",
                    pointBackgroundColor: "#f97316",
                    pointBorderColor: "#ffffff",
                    pointBorderWidth: 2,
                    pointRadius: 6,
                  },
                ],
              },
              options: {
                ...baseConfig,
                scales: {
                  r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                      color: textColor,
                      callback: (value) => value + "%",
                      font: {
                        family: "'Inter', sans-serif",
                      },
                    },
                    grid: { color: gridColor },
                    pointLabels: {
                      color: textColor,
                      font: {
                        family: "'Inter', sans-serif",
                      },
                    },
                  },
                },
              },
            });
          }
        }

        destroyCharts() {
          Object.values(AppState.charts).forEach((chart) => {
            if (chart) {
              chart.destroy();
            }
          });
          AppState.charts = { pie: null, bar: null, efficiency: null };
        }

        getEfficiencyLabel(efficiency) {
          const labels = {
            excellent: "Excelente",
            good: "Buena",
            regular: "Regular",
            poor: "Necesita Mejoras",
          };
          return labels[efficiency] || "Regular";
        }

        getEfficiencyScore(efficiency) {
          const scores = {
            excellent: 95,
            good: 80,
            regular: 60,
            poor: 40,
          };
          return scores[efficiency] || 60;
        }

        resetForm() {
          document.getElementById("processForm").reset();

          // Limpiar errores
          document.querySelectorAll(".form-field").forEach((field) => {
            field.classList.remove("error", "success");
          });
          document.querySelectorAll(".form-error").forEach((error) => {
            error.textContent = "";
          });

          // Limpiar resultados
          document.getElementById("resultsContent").innerHTML = `
      <div class="results-empty">
        <div class="results-empty-icon">üìä</div>
        <div class="results-empty-title">Sin datos que mostrar</div>
        <div class="results-empty-text">Ingresa los datos del proceso para ver el an√°lisis completo con m√©tricas, gr√°ficos y recomendaciones espec√≠ficas para MacPollo</div>
      </div>
    `;

          this.destroyCharts();
          AppState.currentResults = null;

          this.showNotification(
            "success",
            "Formulario Limpiado",
            "Todos los campos han sido restablecidos"
          );
        }

        showNotification(type, title, message) {
          const notification = document.createElement("div");
          notification.className = `notification ${type}`;

          const icon =
            type === "success" ? "‚úÖ" : type === "error" ? "‚ùå" : "‚ÑπÔ∏è";

          notification.innerHTML = `
      <div class="notification-icon">${icon}</div>
      <div class="notification-content">
        <div class="notification-title">${title}</div>
        <div class="notification-message">${message}</div>
      </div>
    `;

          document.body.appendChild(notification);

          setTimeout(() => {
            notification.style.animation = "slideOutRight 0.3s ease forwards";
            setTimeout(() => notification.remove(), 300);
          }, 4000);
        }

        // Utilidades
        delay(ms) {
          return new Promise((resolve) => setTimeout(resolve, ms));
        }

        debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        }
      }

      // Inicializar aplicaci√≥n cuando el DOM est√© listo
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
          window.app = new MacPolloAnalytics();
        });
      } else {
        window.app = new MacPolloAnalytics();
      }
    </script>
    <script src="security.js"></script>
  </body>
</html>
